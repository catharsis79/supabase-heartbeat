name: Supabase Heartbeat

on:
  schedule:
    - cron: "13 7 * * 1,5"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  ping:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Ping Supabase heartbeat
        shell: bash
        env:
          HEARTBEAT_URL: ${{ secrets.HEARTBEAT_URL }}
          HEARTBEAT_SECRET: ${{ secrets.HEARTBEAT_SECRET }}
        run: |
          set -euo pipefail

          : "${HEARTBEAT_URL:?Missing HEARTBEAT_URL secret}"
          : "${HEARTBEAT_SECRET:?Missing HEARTBEAT_SECRET secret}"

          headers_file="$(mktemp)"
          body_file="$(mktemp)"
          trap 'rm -f "$headers_file" "$body_file"' EXIT

          echo "Pinging: ${HEARTBEAT_URL}"
          http_code="$(curl -sS \
            --retry 3 --retry-all-errors \
            --connect-timeout 10 --max-time 30 \
            -D "${headers_file}" \
            -o "${body_file}" \
            -w "%{http_code}" \
            -H "x-heartbeat-secret: ${HEARTBEAT_SECRET}" \
            -H "Accept: text/plain" \
            -H "User-Agent: github-actions-supabase-heartbeat" \
            "${HEARTBEAT_URL}"
          )"

          echo "HTTP ${http_code}"
          if [[ "${http_code}" != "200" ]]; then
            echo "---- Response headers ----"
            sed -n '1,80p' "${headers_file}" || true
            echo "---- Response body (first 300 chars) ----"
            head -c 300 "${body_file}" || true
            echo
            exit 1
          fi

          echo "OK"
